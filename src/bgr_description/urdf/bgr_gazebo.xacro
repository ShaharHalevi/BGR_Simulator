<?xml version="1.0"?>

<robot name="bgr" xmlns:xacro="http://ros.org/wiki/xacro">


  <!-- Gazebo specific parameters -->
  <gazebo reference="Wheel_fl">
    <mu1>1.2</mu1><mu2>1.2</mu2> <!-- coefficient of friction -->
    <surface>
      <friction><ode><mu>1.2</mu><mu2>1.2</mu2><slip1>0.01</slip1><slip2>0.01</slip2></ode></friction> <!-- friction parameters -->
      <contact><ode><kp>1000000.0</kp><kd>1.0</kd><max_vel>0.1</max_vel><min_depth>0.001</min_depth></ode></contact> <!-- contact parameters -->
    </surface>
  </gazebo>

  <gazebo reference="Wheel_fr">
    <mu1>1.2</mu1><mu2>1.2</mu2>
    <surface>
      <friction><ode><mu>1.2</mu><mu2>1.2</mu2><slip1>0.01</slip1><slip2>0.01</slip2></ode></friction>
      <contact><ode><kp>1000000.0</kp><kd>1.0</kd><max_vel>0.1</max_vel><min_depth>0.001</min_depth></ode></contact>
    </surface>
  </gazebo>

  <gazebo reference="Wheel_rl">
    <mu1>1.2</mu1><mu2>1.2</mu2>
    <surface>
      <friction><ode><mu>1.2</mu><mu2>1.2</mu2><slip1>0.01</slip1><slip2>0.01</slip2></ode></friction>
      <contact><ode><kp>1000000.0</kp><kd>1.0</kd><max_vel>0.1</max_vel><min_depth>0.001</min_depth></ode></contact>
    </surface>
  </gazebo>

  <gazebo reference="Wheel_rr">
    <mu1>1.2</mu1><mu2>1.2</mu2>
    <surface>
      <friction><ode><mu>1.2</mu><mu2>1.2</mu2><slip1>0.01</slip1><slip2>0.01</slip2></ode></friction>
      <contact><ode><kp>1000000.0</kp><kd>1.0</kd><max_vel>0.1</max_vel><min_depth>0.001</min_depth></ode></contact>
    </surface>
  </gazebo>

  <!-- Chassis friction -->
  <gazebo reference="base_link">
    <mu1>0.2</mu1><mu2>0.2</mu2>
  </gazebo>


  <!-- ROS 2 Control -->
  <gazebo>
    <!-- ROS 2 Humble -->
    <xacro:if value="$(arg is_ignition)">
      <plugin filename="ign_ros2_control-system" name="ign_ros2_control::IgnitionROS2ControlPlugin">
        <parameters>$(find bgr_controller)/config/bgr_controllers.yaml</parameters>
      </plugin>
    </xacro:if>

    <!-- ROS 2 Iron or above -->
    <xacro:unless value="$(arg is_ignition)">
      <plugin filename="gz_ros2_control-system" name="gz_ros2_control::GazeboSimROS2ControlPlugin">
        <parameters>$(find bgr_controller)/config/bgr_controllers.yaml</parameters>
      </plugin>
    </xacro:unless>
  </gazebo>

  <!-- Publishes /joint_states for all defined joints -->
  <gazebo>
    <plugin filename="gz-sim-joint-state-publisher-system" name="gz::sim::systems::JointStatePublisher">
      <topic>joint_states</topic>
      <joint_name>Wheel_rl_joint</joint_name>
      <joint_name>Wheel_rr_joint</joint_name>
      <joint_name>Wheel_fl_joint</joint_name>
      <joint_name>Wheel_fr_joint</joint_name>
      <joint_name>Steering_fl_joint</joint_name>
      <joint_name>Steering_fr_joint</joint_name>
    </plugin>
  </gazebo>

  <!-- Enforce steering mimic in physics (FL follows FR) -->
  <gazebo>
    <plugin filename="gz-sim-mimic-joint-system" name="gz::sim::systems::MimicJoint">
      <joint_name>Steering_fl_joint</joint_name>
      <mimicked_joint>Steering_fr_joint</mimicked_joint>
      <multiplier>-1.0</multiplier>
      <offset>0.0</offset>
    </plugin>
  </gazebo>

  <!-- Wheel slip plugin for better rolling behavior (all wheels) -->
  <gazebo>
    <plugin filename="gz-sim-wheel-slip-system" name="gz::sim::systems::WheelSlip">
      <wheel link_name="Wheel_rr">
        <slip_compliance_lateral>0.05</slip_compliance_lateral>
        <slip_compliance_longitudinal>0.001</slip_compliance_longitudinal>
      </wheel>
      <wheel link_name="Wheel_rl">
        <slip_compliance_lateral>0.05</slip_compliance_lateral>
        <slip_compliance_longitudinal>0.001</slip_compliance_longitudinal>
      </wheel>
      <wheel link_name="Wheel_fr">
        <slip_compliance_lateral>0.05</slip_compliance_lateral>
        <slip_compliance_longitudinal>0.001</slip_compliance_longitudinal>
      </wheel>
      <wheel link_name="Wheel_fl">
        <slip_compliance_lateral>0.05</slip_compliance_lateral>
        <slip_compliance_longitudinal>0.001</slip_compliance_longitudinal>
      </wheel>
    </plugin>
  </gazebo>
</robot>
